function [] = roiregress()

% bdir = '/home/aglatz/sf_V_DRIVE/Andreas_PhD/QMRI/Subjects/';
% sdirs = {'20025/R1HIFI', ...
%          '19994/R1HIFI', ...
%          '19990/R1HIFI', ...
%          '19989/R1HIFI', ...
%          '19977/R1HIFI', ...
%          '19952/R1HIFI', ...
%          '19950/R1HIFI', ...
%          '19949/R1HIFI', ...
%          '19860/R1HIFI'};
% ages = [33, 32, 44, 28, 42, 28, 38, 29, 44];
% fname = 'DESPOT1HIFI_T1Map.mat';
%%%
% sdirs = {'20025/R1', ...
%          '19994/R1', ...
%          '19990/R1', ...
%          '19989/R1', ...
%          '19977/R1', ...
%          '19952/R1', ...
%          '19950/R1', ...
%          '19949/R1', ...
%          '19860/R1'};
% ages = [33, 32, 44, 28, 42, 28, 38, 29, 44];
% fname = 'DESPOT1_T1Map.mat';
%%%
% sdirs = {'20025/R1_2fa', ...
%          '19994/R1_2fa', ...
%          '19990/R1_2fa', ...
%          '19989/R1_2fa', ...
%          '19977/R1_2fa', ...
%          '19952/R1_2fa', ...
%          '19950/R1_2fa', ...
%          '19949/R1_2fa', ...
%          '19860/R1_2fa'};
% ages = [33, 32, 44, 28, 42, 28, 38, 29, 44, 36];
% fname = 'DESPOT1_T1Map.mat';
%%%
% sdirs = {'20025/14', ...
%          '19994/12', ...
%          '19990/13', ...
%          '19989/5', ...
%          '19977/5', ...
%          '19860/22', ...
%          '19811/7'};
% fname = 'R2.mat';
% ages = [33, 32, 44, 28, 42, 44, 36];
%%%
% sdirs = {'20025/11', ...
%          '19994/11', ...
%          '19990/12', ...
%          '19989/4', ...
%          '19977/4', ...
%          '19860/19', ...
%          '19811/5'};
%          '19952/19', ...
%          '19950/18', ...
%          '19949/19', ...

%ages = [33, 32, 44, 28, 42, 28, 38, 29, 44, 36];
% fname = 'R2s.mat';
%%%
% sdirs = {'20025/13', ...
%          '19994/15', ...
%          '19990/14', ...
%          '19989/14', ...
%          '19977/13', ...
%          '19952/20', ...
%          '19950/20', ...
%          '19949/21', ...
%          '19860/23', ...
%          '19811/8'};
% ages = [33, 32, 44, 28, 42, 28, 38, 29, 44, 36];
% fname = 'R2s_se.mat';
%%%
bdir = '/home/aglatz/sf_V_DRIVE/Andreas_PhD/QMRI/Phantom/MnCl2/';
% sdirs = {'22218/R1HIFI', ...
%          '19991/R1HIFI', ...
%          '19941/R1HIFI', ...
%          '19928/R1HIFI', ...
%          '19906/R1HIFI_low', ...
%          '19895/R1HIFI', ...
%          '19892/R1HIFI_low', ...
%          '19890/R1HIFI'};
% ages = length(sdirs):-1:1;
% conc = [0 0.05:0.02:0.21];
% fname = 'DESPOT1HIFI_T1Map.mat';
%%%
% sdirs = {'20315/R1', ...
%          '19991/R1', ...
%          '19941/R1', ...
%          '19928/R1', ...
%          '19906/R1', ...
%          '19895/R1', ...
%          '19892/R1', ...
%          '19890/R1'};
% ages = 1:length(sdirs);
% conc = [0 0.05:0.02:0.21];
% fname = 'DESPOT1_T1Map.mat';
%%%
% sdirs = {'22218/R1_2fa', ...
%          '20315/R1_2fa', ...
%          '19991/R1_2fa', ...
%          '19941/R1_2fa', ...
%          '19928/R1_2fa', ...
%          '19906/R1_2fa', ...
%          '19895/R1_2fa', ...
%          '19892/R1_2fa', ...
%          '19890/R1_2fa'};
% ages = length(sdirs):-1:1;
% conc = [0 0.05:0.02:0.21];
% fname = 'DESPOT1_T1Map.mat';
%%%
% sdirs = {'22218/17', ...
%          '20315/14', ...
%          '20026/4', ...
%          '19991/8', ...
%          '19941/24', ...
%          '19928/3', ...
%          '19895/30', ...
%          '19701/12'};
% ages = length(sdirs):-1:1;
% conc = [0 0.05:0.02:0.21];
% fname = 'R2.mat';
%%%
% sdirs = {'22218/16', ...
%          '20315/5', ...
%          '20026/3', ...
%          '19941/23', ...
%          '19906/20', ...
%          '19895/29', ...
%          '19701/10'};
% ages = 1:length(sdirs);
% conc = [0 0.05:0.02:0.21];
% fname = 'R2s.mat';
%%%-------------------------
% sdirs = {...'22218/R1_2fa', ...
%          '20315/R1_2fa', ...
%          '19991/R1_2fa', ...
%          '19941/R1_2fa', ...
%          '19928/R1_2fa', ...
%          '19906/R1_2fa', ...
%          '19895/R1_2fa'};
% cal = 1;
% ages = [95 21 11 7 4 0];
% conc = [0 0.05:0.02:0.21];
% fname = 'DESPOT1_T1Map.mat';
%%%
% sdirs = {...'22218/17', ...
%          '20315/14', ...
%          '20026/4', ...
%          '19991/8', ...
%          '19941/24', ...
%          '19928/3', ...
%          '19895/30'};
% cal = 2;
% ages = [95 28 21 11 7 0];
% conc = [0 0.05:0.02:0.21];
% fname = 'R2.mat';
%%%
sdirs = {...'22218/16', ... 582
         '20315/5', ...
         '20026/3', ...
         '19941/23', ...
         '19906/20', ...
         '19895/29'}; %, ...
         %'19701/10'}; -42
cal = 3;
ages = [95 28  11 4 0];
conc = [0 0.05:0.02:0.21];
fname = 'R2s.mat';

Mat = NaN(length(ages), 5); %length(conc));
for idx = 1:length(sdirs)
    load(fullfile(bdir, sdirs{idx}, fname));
    for idx_c = 1:length(X)
        Tmp = abs(conc-X(idx_c));
        M = Tmp == min(Tmp);
        Mat(idx, M) = Y(idx_c);
    end
    Tmp = cell2mat(C);
%     Mat(idx, :) = [median(cell2mat(C([1],1))), ...
%                    median(cell2mat(C([2,3],1))), ...
%                    median(cell2mat(C([4,5],1))), ...
%                    median(cell2mat(C([6,7],1))), ...
%                    median(cell2mat(C([8],1)))];
%                
%     Tmp = [[cell2mat(C([1],1)) ones(size(cell2mat(C([1],1))))*1];
%            [cell2mat(C([2,3],1)) ones(size(cell2mat(C([2,3],1))))*2];
%            [cell2mat(C([4,5],1)) ones(size(cell2mat(C([4,5],1))))*3];
%            [cell2mat(C([6,7],1)) ones(size(cell2mat(C([6,7],1))))*4];
%            [cell2mat(C([8],1)) ones(size(cell2mat(C([8],1))))*5];];

    [p, tbl, stats]=kruskalwallis(Tmp(:, 1), Tmp(:, 2), 'off');
    Res = multcompare(stats, 'display','off');
    Tmp = sign(Res(:, 3)) + sign(Res(:, 5));
    fprintf('--- %s 1(Syr), 2(C), 3(P), 4(G), 5(WM) ---\n', sdirs{idx});
    p
    Res(Tmp < 2 & Tmp > -2, 1:2)
end
% M = abs(Mat(:, 1) - 10)>5;
% Mat(M, 1) = NaN;

figure
Labs = {'0', '0.05', '0.07', '0.09', '0.11', '0.13', '0.15', '0.17', '0.19', '0.21'};
plot_relaxivity(ages, Mat, Labs, cal);

out = NaN(size(Mat,2));
% fprintf('--- Quantile ---\n');
% out(1:3,:) = quantile(Mat, [.95 .5 .05])
fprintf('--- Coefficient of variation in %% ---\n');
out = std(Mat,1)./mean(Mat,1)*100;
for idx = 1:size(Mat,2)
    fprintf('%s: %0.2f%%, %0.2f%%\n', ...
            Labs{idx}, out(idx), mscalelogist(Mat(:, idx))./mloclogist(Mat(:, idx))*100);
end

% fprintf('--- Mean/SD ---\n');
% out(5:6,:) = [mean(Mat,1); std(Mat,1)]
% csvwrite(fullfile(bdir, sdirs{1}, [fname 'all.csv']), out);

% figure;
% cal = 0;
% subplot(2,2,1);
% hold on;
% % Idx = [2, 3, 8];
% % Labs = {'Cr', 'Cl', 'WM'};
% Idx = [2];
% Labs = {'C'};
% plot_relaxivity(ages, Mat(:, Idx), Labs, cal);
% subplot(2,2,2);
% hold on;
% % Idx = [4, 5, 8];
% % Labs = {'Pr', 'Pl', 'WM'};
% Idx = [3];
% Labs = {'P'};
% plot_relaxivity(ages, Mat(:, Idx), Labs, cal);
% subplot(2,2,3);
% hold on;
% % Idx = [6, 7, 8];
% % Labs = {'Gr', 'Gl', 'WM'};
% Idx = [4];
% Labs = {'G'};
% plot_relaxivity(ages, Mat(:, Idx), Labs, cal);
% subplot(2,2,4);
% hold on;
% plot_relaxivity(ages, Mat(:, [5]), {'WM'}, cal);
% set(gcf, 'color','white');

% 
% figure;
% %subplot(2,2,1);
% C1 = 9.66*(1-exp(-0.05.*ages))+0.33;
% %plot_relaxivity(C, Mat(:, 2), {'C'});
% %subplot(2,2,2);
% C2 = 14.62*(1-exp(-0.04.*ages))+0.46;
% %plot_relaxivity(C, Mat(:, 3), {'P'});
% %subplot(2,2,3);
% C3 = 21.41*(1-exp(-0.09.*ages))+0.37;
% %plot_relaxivity(C, Mat(:, 4), {'G'});
% %subplot(2,2,4);
% C4 = 3.95*(1-exp(-0.1.*ages))+0.31;
% plot_relaxivity([C1,C2,C3], [Mat(:, 2); Mat(:, 3); Mat(:, 4)], {'WM'});
% 
% figure;
% %subplot(2,2,1);
% C1 = 9.66*(1-exp(-0.05.*ages))+0.33;
% plot_relaxivity(C1, Mat(:, 2), {'C'});
% %subplot(2,2,2);
% C2 = 14.62*(1-exp(-0.04.*ages))+0.46;
% plot_relaxivity(C2, Mat(:, 3), {'P'});
% %subplot(2,2,3);
% C3 = 21.41*(1-exp(-0.09.*ages))+0.37;
% plot_relaxivity(C3, Mat(:, 4), {'G'});
% %subplot(2,2,4);
% % C4 = 3.95*(1-exp(-0.1.*ages))+0.31;
% % plot_relaxivity([C1,C2,C3], [Mat(:, 2); Mat(:, 3); Mat(:, 4)], {'WM'});
    
function [Pci] = plot_relaxivity(Ages, Mat, Lab, cal)
hold on
switch cal
    case 1,
        Mat = 1.30*Mat-0.09;
    case 2,
        Mat = 1.02*Mat+0.24;
    case 3,
        Mat = 0.97*Mat+0.86;
    otherwise,
end
Idx = 1:length(Mat(1,:));
%Col = hsv(length(Idx));
for idx = Idx
    if mod(idx,2) == 0
        sym = '+';
    else
        sym = 'o';
    end
    scatter(Ages, Mat(:, idx), 20, 'b', sym);
end
legend(Lab);
%Pci = zeros(3, 2, length(Idx));
Ph = NaN(2, 2, length(Idx));
Cor = NaN(length(Idx), 5);
for idx = Idx
    M = ~isnan(Mat(:, idx));
    try
    [r,~,~,~,~,CI] = skipped_correlation(Ages(M), Mat(M, idx), 0);
    %Cor(idx, :) = [CI.Spearman(1) r.Spearman CI.Spearman(2)];
    Cor(idx, 1:3) = [CI.Pearson(1) r.Pearson CI.Pearson(2)];
    catch
    end
    [Cor(idx, [4]), Cor(idx, [5])] = corr(Ages(M)', Mat(M, idx));
    %fun = @(Idxci) robustfit(Ages(Idxci), Mat(Idxci, idx));
    %Pci([1 3], :, idx) = bootci(100, fun, 1:length(Ages));
    %P = fun(1:length(Ages));
    %Pci(2, :, idx) = P;
    P = robustfit(Ages(M), Mat(M, idx));
    plot([min(Ages) max(Ages)], polyval([P(2) P(1)], [min(Ages) max(Ages)]), 'k', 'LineWidth', 2); %'color', Col(idx, :));
%     P = quantreg(Ages(M)', Mat(M, idx), .5, 1);
%     plot([min(Ages) max(Ages)], polyval([P(1) P(2)], [min(Ages) max(Ages)]), 'color', Col(idx, :));
    xlabel('\bf Age in years');
    ylabel('\bf Relaxation rate in s^{-1}');
    fprintf('%s, k=%0.2fms^{-1}/days; d=%0.2fs^{-1}\n', Lab{idx}, P(2)*1000, P(1));
end

fprintf('--- %s ---\n', cell2mat(Lab));
%Pci
Cor
